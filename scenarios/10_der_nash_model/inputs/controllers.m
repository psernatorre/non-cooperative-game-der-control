clear 
clc

load("state_space.mat")

%% Objective function

PV1.Ru = 1; % Control weighted matrix of PV1 
BESS2.Ru = 5; % Control weighted matrix of BESS2
BESS3.Ru = 6; % Control weighted matrix of BESS3
PV4.Ru = 2.5; % Control weighted matrix of PV4
PV5.Ru = 1.5; % Control weighted matrix of PV5
BESS6.Ru = 4.5; % Control weighted matrix of BESS6
PV7.Ru = 0.2; % Control weighted matrix of PV7
BESS8.Ru = 6; % Control weighted matrix of BESS8
BESS9.Ru = 4.5; % Control weighted matrix of BESS9
BESS10.Ru = 4; % Control weighted matrix of BESS9

PV1.Qs = blkdiag(5*(PV1.C'*PV1.C), ...
                2*(BESS2.C'*BESS2.C), ...
                1*(BESS3.C'*BESS3.C), ...
                4*(PV4.C'*PV4.C), ...
                3*(PV5.C'*PV5.C), ...
                0.5*(BESS6.C'*BESS6.C), ...
                1*(PV7.C'*PV7.C), ...
                4*(BESS8.C'*BESS8.C), ...
                0.5*(BESS9.C'*BESS9.C), ...
                1*(BESS10.C'*BESS10.C)) ;

BESS2.Qs = blkdiag(3*(PV1.C'*PV1.C), ...
                   5*(BESS2.C'*BESS2.C), ...
                   1*(BESS3.C'*BESS3.C), ...
                   0.5*(PV4.C'*PV4.C), ...
                   0.5*(PV5.C'*PV5.C), ...
                   1*(BESS6.C'*BESS6.C), ...
                   1.5*(PV7.C'*PV7.C),...
                   2*(BESS8.C'*BESS8.C), ...
                   0.7*(BESS9.C'*BESS9.C),...
                   0.5*(BESS10.C'*BESS10.C)) ;

BESS3.Qs = blkdiag(1*(PV1.C'*PV1.C), ...
                   1*(BESS2.C'*BESS2.C), ...
                   8*(BESS3.C'*BESS3.C), ...
                   2*(PV4.C'*PV4.C), ...
                   2.5*(PV5.C'*PV5.C), ...
                   1*(BESS6.C'*BESS6.C), ...
                   0.8*(PV7.C'*PV7.C),...
                   1*(BESS8.C'*BESS8.C), ...
                   0.7*(BESS9.C'*BESS9.C),...
                   1.5*(BESS10.C'*BESS10.C)) ;

PV4.Qs = blkdiag(1*(PV1.C'*PV1.C), ...
                 1*(BESS2.C'*BESS2.C), ...
                 3.5*(BESS3.C'*BESS3.C), ...
                 5.5*(PV4.C'*PV4.C), ...
                 3*(PV5.C'*PV5.C), ...
                 2*(BESS6.C'*BESS6.C), ...
                 0.8*(PV7.C'*PV7.C),...
                 2.5*(BESS8.C'*BESS8.C), ...
                 0.9*(BESS9.C'*BESS9.C),...
                 1.1*(BESS10.C'*BESS10.C));

PV5.Qs = blkdiag(1*(PV1.C'*PV1.C), ...
                 2*(BESS2.C'*BESS2.C), ...
                 0.2*(BESS3.C'*BESS3.C), ...
                 2*(PV4.C'*PV4.C), ...
                 10*(PV5.C'*PV5.C), ...
                 1*(BESS6.C'*BESS6.C), ...
                 0.8*(PV7.C'*PV7.C),...
                 0.7*(BESS8.C'*BESS8.C), ...
                 3*(BESS9.C'*BESS9.C),...
                 5*(BESS10.C'*BESS10.C));

BESS6.Qs = blkdiag(1*(PV1.C'*PV1.C), ...
                   2*(BESS2.C'*BESS2.C), ...
                   0.4*(BESS3.C'*BESS3.C), ...
                   1*(PV4.C'*PV4.C), ...
                   0.1*(PV5.C'*PV5.C), ...
                   8*(BESS6.C'*BESS6.C), ...
                   0.8*(PV7.C'*PV7.C),...
                   0.7*(BESS8.C'*BESS8.C), ...
                   5*(BESS9.C'*BESS9.C),...
                   1*(BESS10.C'*BESS10.C));

PV7.Qs = blkdiag(1*(PV1.C'*PV1.C), ...
                 2*(BESS2.C'*BESS2.C), ...
                 0.4*(BESS3.C'*BESS3.C), ...
                 1*(PV4.C'*PV4.C), ...
                 0.1*(PV5.C'*PV5.C), ...
                 2.5*(BESS6.C'*BESS6.C), ...
                 7*(PV7.C'*PV7.C),...
                 0.7*(BESS8.C'*BESS8.C), ...
                 5*(BESS9.C'*BESS9.C),...
                 1*(BESS10.C'*BESS10.C));

BESS8.Qs = blkdiag(1*(PV1.C'*PV1.C), ...
                   3*(BESS2.C'*BESS2.C), ...
                   0.4*(BESS3.C'*BESS3.C), ...
                   1*(PV4.C'*PV4.C), ...
                   0.1*(PV5.C'*PV5.C), ...
                   1.5*(BESS6.C'*BESS6.C), ...
                   0.7*(PV7.C'*PV7.C),...
                   7*(BESS8.C'*BESS8.C), ...
                   2*(BESS9.C'*BESS9.C),...
                   1*(BESS10.C'*BESS10.C));

BESS9.Qs = blkdiag(1*(PV1.C'*PV1.C), ...
                   3*(BESS2.C'*BESS2.C), ...
                   0.4*(BESS3.C'*BESS3.C), ...
                   1*(PV4.C'*PV4.C), ...
                   0.1*(PV5.C'*PV5.C), ...
                   1.5*(BESS6.C'*BESS6.C), ...
                   0.7*(PV7.C'*PV7.C),...
                   2*(BESS8.C'*BESS8.C), ...
                   5*(BESS9.C'*BESS9.C),...
                   1*(BESS10.C'*BESS10.C));

BESS10.Qs = blkdiag(1*(PV1.C'*PV1.C), ...
                   3*(BESS2.C'*BESS2.C), ...
                   0.4*(BESS3.C'*BESS3.C), ...
                   1*(PV4.C'*PV4.C), ...
                   0.1*(PV5.C'*PV5.C), ...
                   1.5*(BESS6.C'*BESS6.C), ...
                   0.7*(PV7.C'*PV7.C),...
                   2*(BESS8.C'*BESS8.C), ...
                   2*(BESS9.C'*BESS9.C),...
                   10*(BESS10.C'*BESS10.C));


%Augmented parameters of the objective function for deviation system
PV1.Q_aug = blkdiag(PV1.Qs, 625);
           
BESS2.Q_aug = blkdiag(BESS2.Qs, 400);

BESS3.Q_aug = blkdiag(BESS3.Qs, 484);

PV4.Q_aug = blkdiag(PV4.Qs, 729);

PV5.Q_aug = blkdiag(PV5.Qs, 324);

BESS6.Q_aug = blkdiag(BESS6.Qs, 64);

PV7.Q_aug = blkdiag(PV7.Qs, 256);

BESS8.Q_aug = blkdiag(BESS8.Qs, 225);

BESS9.Q_aug = blkdiag(BESS9.Qs, 169);

BESS10.Q_aug = blkdiag(BESS10.Qs, 144);

%Augmented state space representation to track input
A_aug = [A zeros(20,1);-C 0]; %20 = 10 DERS * 2 states per der
B_aug = blkdiag(B,0);
B1_aug = B_aug(:,1);
B2_aug = B_aug(:,2);
B3_aug = B_aug(:,3);
B4_aug = B_aug(:,4);
B5_aug = B_aug(:,5);
B6_aug = B_aug(:,6);
B7_aug = B_aug(:,7);
B8_aug = B_aug(:,8);
B9_aug = B_aug(:,9);
B10_aug = B_aug(:,10);

%Test controllability of the system
Co = ctrb(A_aug, B_aug);
rank(Co)

PV1.S = B1_aug*(PV1.Ru)^(-1)*B1_aug';
BESS2.S = B2_aug*(BESS2.Ru)^(-1)*B2_aug';
BESS3.S = B3_aug*(BESS3.Ru)^(-1)*B3_aug';
PV4.S = B4_aug*(PV4.Ru)^(-1)*B4_aug';
PV5.S = B5_aug*(PV5.Ru)^(-1)*B5_aug';
BESS6.S = B6_aug*(BESS6.Ru)^(-1)*B6_aug';
PV7.S = B7_aug*(PV7.Ru)^(-1)*B7_aug';
BESS8.S = B8_aug*(BESS8.Ru)^(-1)*B8_aug';
BESS9.S = B9_aug*(BESS9.Ru)^(-1)*B9_aug';
BESS10.S = B10_aug*(BESS10.Ru)^(-1)*B10_aug';

P = cell(10,1);
Ak = cell(10,1);

Ak{1} = A_aug;
Ak{2} = A_aug;
Ak{3} = A_aug;
Ak{4} = A_aug;
Ak{5} = A_aug;
Ak{6} = A_aug;
Ak{7} = A_aug;
Ak{8} = A_aug;
Ak{9} = A_aug;
Ak{10} = A_aug;

for k=1:90

P{1} = icare(Ak{1},[],PV1.Q_aug,[],[],[],-PV1.S);
P{2} = icare(Ak{2},[],BESS2.Q_aug,[],[],[],-BESS2.S);
P{3} = icare(Ak{3},[],BESS3.Q_aug,[],[],[],-BESS3.S);
P{4} = icare(Ak{4},[],PV4.Q_aug,[],[],[],-PV4.S);
P{5} = icare(Ak{5},[],PV5.Q_aug,[],[],[],-PV5.S);
P{6} = icare(Ak{6},[],BESS6.Q_aug,[],[],[],-BESS6.S);
P{7} = icare(Ak{7},[],PV7.Q_aug,[],[],[],-PV7.S);
P{8} = icare(Ak{8},[],BESS8.Q_aug,[],[],[],-BESS8.S);
P{9} = icare(Ak{9},[],BESS9.Q_aug,[],[],[],-BESS9.S);
P{10} = icare(Ak{10},[],BESS10.Q_aug,[],[],[],-BESS10.S);

Ak{1}  = A_aug - 0*PV1.S*P{1} - 1*BESS2.S*P{2} - 1*BESS3.S*P{3} - 1*PV4.S*P{4} - 1*PV5.S*P{5} - 1*BESS6.S*P{6} - 1*PV7.S*P{7} - 1*BESS8.S*P{8} - 1*BESS9.S*P{9} - 1*BESS10.S*P{10};
Ak{2}  = A_aug - 1*PV1.S*P{1} - 0*BESS2.S*P{2} - 1*BESS3.S*P{3} - 1*PV4.S*P{4} - 1*PV5.S*P{5} - 1*BESS6.S*P{6} - 1*PV7.S*P{7} - 1*BESS8.S*P{8} - 1*BESS9.S*P{9} - 1*BESS10.S*P{10};
Ak{3}  = A_aug - 1*PV1.S*P{1} - 1*BESS2.S*P{2} - 0*BESS3.S*P{3} - 1*PV4.S*P{4} - 1*PV5.S*P{5} - 1*BESS6.S*P{6} - 1*PV7.S*P{7} - 1*BESS8.S*P{8} - 1*BESS9.S*P{9} - 1*BESS10.S*P{10};
Ak{4}  = A_aug - 1*PV1.S*P{1} - 1*BESS2.S*P{2} - 1*BESS3.S*P{3} - 0*PV4.S*P{4} - 1*PV5.S*P{5} - 1*BESS6.S*P{6} - 1*PV7.S*P{7} - 1*BESS8.S*P{8} - 1*BESS9.S*P{9} - 1*BESS10.S*P{10};
Ak{5}  = A_aug - 1*PV1.S*P{1} - 1*BESS2.S*P{2} - 1*BESS3.S*P{3} - 1*PV4.S*P{4} - 0*PV5.S*P{5} - 1*BESS6.S*P{6} - 1*PV7.S*P{7} - 1*BESS8.S*P{8} - 1*BESS9.S*P{9} - 1*BESS10.S*P{10};
Ak{6}  = A_aug - 1*PV1.S*P{1} - 1*BESS2.S*P{2} - 1*BESS3.S*P{3} - 1*PV4.S*P{4} - 1*PV5.S*P{5} - 0*BESS6.S*P{6} - 1*PV7.S*P{7} - 1*BESS8.S*P{8} - 1*BESS9.S*P{9} - 1*BESS10.S*P{10};
Ak{7}  = A_aug - 1*PV1.S*P{1} - 1*BESS2.S*P{2} - 1*BESS3.S*P{3} - 1*PV4.S*P{4} - 1*PV5.S*P{5} - 1*BESS6.S*P{6} - 0*PV7.S*P{7} - 1*BESS8.S*P{8} - 1*BESS9.S*P{9} - 1*BESS10.S*P{10};
Ak{8}  = A_aug - 1*PV1.S*P{1} - 1*BESS2.S*P{2} - 1*BESS3.S*P{3} - 1*PV4.S*P{4} - 1*PV5.S*P{5} - 1*BESS6.S*P{6} - 1*PV7.S*P{7} - 0*BESS8.S*P{8} - 1*BESS9.S*P{9} - 1*BESS10.S*P{10};
Ak{9}  = A_aug - 1*PV1.S*P{1} - 1*BESS2.S*P{2} - 1*BESS3.S*P{3} - 1*PV4.S*P{4} - 1*PV5.S*P{5} - 1*BESS6.S*P{6} - 1*PV7.S*P{7} - 1*BESS8.S*P{8} - 0*BESS9.S*P{9} - 1*BESS10.S*P{10};
Ak{10} = A_aug - 1*PV1.S*P{1} - 1*BESS2.S*P{2} - 1*BESS3.S*P{3} - 1*PV4.S*P{4} - 1*PV5.S*P{5} - 1*BESS6.S*P{6} - 1*PV7.S*P{7} - 1*BESS8.S*P{8} - 1*BESS9.S*P{9} - 0*BESS10.S*P{10};


end

%Checking solutions of the coupled riccati equations
check_req = cell(10,1);

check_req{1} = Ak{1}'*P{1} + P{1}*Ak{1} - P{1}*PV1.S*P{1} + PV1.Q_aug ;
min(check_req{1},[],"all")
max(check_req{1},[],"all")

check_req{2} = Ak{2}'*P{2} + P{2}*Ak{2} - P{2}*BESS2.S*P{2} + BESS2.Q_aug ;
min(check_req{2},[],"all")
max(check_req{2},[],"all")

check_req{3} = Ak{3}'*P{3} + P{3}*Ak{3} - P{3}*BESS3.S*P{3} + BESS3.Q_aug ;
min(check_req{3},[],"all")
max(check_req{3},[],"all")

check_req{4} = Ak{4}'*P{4} + P{4}*Ak{4} - P{4}*PV4.S*P{4} + PV4.Q_aug ; 
min(check_req{4},[],"all")
max(check_req{4},[],"all")

check_req{5} = Ak{5}'*P{5} + P{5}*Ak{5} - P{5}*PV5.S*P{5} + PV5.Q_aug ;
min(check_req{5},[],"all")
max(check_req{5},[],"all")

check_req{6} = Ak{6}'*P{6} + P{6}*Ak{6} - P{6}*BESS6.S*P{6} + BESS6.Q_aug ;
min(check_req{6},[],"all")
max(check_req{6},[],"all")

check_req{7} = Ak{7}'*P{7} + P{7}*Ak{7} - P{7}*PV7.S*P{7} + PV7.Q_aug ;
min(check_req{7},[],"all")
max(check_req{7},[],"all")

check_req{8} = Ak{8}'*P{8} + P{8}*Ak{8} - P{8}*BESS8.S*P{8} + BESS8.Q_aug ;
min(check_req{8},[],"all")
max(check_req{8},[],"all")

check_req{9} = Ak{9}'*P{9} + P{9}*Ak{9} - P{9}*BESS9.S*P{9} + BESS9.Q_aug;
min(check_req{9},[],"all")
max(check_req{9},[],"all")

check_req{10} = Ak{10}'*P{10} + P{10}*Ak{10} - P{10}*BESS10.S*P{10} + BESS10.Q_aug;
min(check_req{10},[],"all")
max(check_req{10},[],"all")

% The following must be stable
eig(A_aug - PV1.S*P{1} - BESS2.S*P{2} - BESS3.S*P{3} - PV4.S*P{4} - PV5.S*P{5} - BESS6.S*P{6} - PV7.S*P{7} - BESS8.S*P{8} - BESS9.S*P{9} - BESS10.S*P{10})

% Coupled Riccati equation solutions (to consider in objective function)

PV1.PRic = P{1};
BESS2.PRic = P{2};
BESS3.PRic = P{3};
PV4.PRic = P{4};
PV5.PRic = P{5};
BESS6.PRic = P{6};
PV7.PRic = P{7};
BESS8.PRic = P{8};
BESS9.PRic = P{9};
BESS10.PRic = P{10};

% Controllers
F1 = -(PV1.Ru)^(-1)*B1_aug'*P{1};
F2 = -(BESS2.Ru)^(-1)*B2_aug'*P{2};
F3 = -(BESS3.Ru)^(-1)*B3_aug'*P{3};
F4 = -(PV4.Ru)^(-1)*B4_aug'*P{4};
F5 = -(PV5.Ru)^(-1)*B5_aug'*P{5};
F6 = -(BESS6.Ru)^(-1)*B6_aug'*P{6};
F7 = -(PV7.Ru)^(-1)*B7_aug'*P{7};
F8 = -(BESS8.Ru)^(-1)*B8_aug'*P{8};
F9 = -(BESS9.Ru)^(-1)*B9_aug'*P{9};
F10 = -(BESS10.Ru)^(-1)*B10_aug'*P{10};

PV1.NE_kp = F1(1:20);
PV1.NE_ki = F1(end);

BESS2.NE_kp = F2(1:20);
BESS2.NE_ki = F2(end);

BESS3.NE_kp = F3(1:20);
BESS3.NE_ki = F3(end);

PV4.NE_kp = F4(1:20);
PV4.NE_ki = F4(end);

PV5.NE_kp = F5(1:20);
PV5.NE_ki = F5(end);

BESS6.NE_kp = F6(1:20);
BESS6.NE_ki = F6(end);

PV7.NE_kp = F7(1:20);
PV7.NE_ki = F7(end);

BESS8.NE_kp = F8(1:20);
BESS8.NE_ki = F8(end);

BESS9.NE_kp = F9(1:20);
BESS9.NE_ki = F9(end);

BESS10.NE_kp = F10(1:20);
BESS10.NE_ki = F10(end);

%% Save data
save("state_space_and_controllers", ...
    "A", "B", "C", ...
    "PV1", ...
    "BESS2", ...
    "BESS3",...
    "PV4", ...
    "PV5", ...
    "BESS6",...
    "PV7",...
    "BESS8",...
    "BESS9",...
    "BESS10",...
    "Grid", ...
    "Load");

